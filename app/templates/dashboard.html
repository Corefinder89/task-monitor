<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Monitor Dashboard - D3.js Nightingale Charts</title>
    <!-- Primary CDN -->
    <script src="https://d3js.org/d3.v7.min.js" onerror="loadBackupD3()"></script>
    <!-- Backup CDNs -->
    <script>
        function loadBackupD3() {
            console.log('Primary D3 CDN failed, trying backup...');
            const script1 = document.createElement('script');
            script1.src = 'https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js';
            script1.onerror = function () {
                console.log('Backup CDN 1 failed, trying CDN 2...');
                const script2 = document.createElement('script');
                script2.src = 'https://unpkg.com/d3@7/dist/d3.min.js';
                script2.onerror = function () {
                    console.error('All D3 CDNs failed!');
                    document.body.innerHTML = '<div style="text-align:center;margin-top:50px;"><h2 style="color:red;">‚ùå D3.js library failed to load from all CDNs</h2><p>Please check your internet connection and refresh the page.</p></div>';
                };
                document.head.appendChild(script2);
            };
            document.head.appendChild(script1);
        }
    </script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>

<body>
    <div class="container">
        <header>
            <h1>Task Monitor Dashboard</h1>
            <p class="subtitle">Real-time Process Performance Visualization</p>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Processes</h3>
                <div class="stat-value" id="total-processes">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Memory (MB)</h3>
                <div class="stat-value" id="total-memory">-</div>
            </div>
            <div class="stat-card">
                <h3>Total CPU (%)</h3>
                <div class="stat-value" id="total-cpu">-</div>
            </div>
            <div class="stat-card">
                <h3>Last Updated</h3>
                <div class="stat-value" id="last-updated">-</div>
            </div>
        </div>

        <div class="view-selector">
            <h2>Select View</h2>
            <div class="selector-options">
                <label class="selector-option">
                    <input type="radio" name="view-type" value="monitoring" checked>
                    <span class="selector-label">üìä Monitoring</span>
                    <span class="selector-description">Real-time process monitoring</span>
                </label>
                <label class="selector-option">
                    <input type="radio" name="view-type" value="snapshot">
                    <span class="selector-label">üì∏ Snapshot</span>
                    <span class="selector-description">Performance snapshot view</span>
                </label>
            </div>
        </div>

        <div class="charts-grid" id="monitoring-view">
            <div class="chart-container">
                <h2>Memory Usage - Performance Monitoring</h2>
                <div id="memory-monitoring-chart" class="chart"></div>
                <button class="refresh-btn" onclick="refreshChart('memory-monitoring')">Refresh</button>
            </div>

            <div class="chart-container">
                <h2>CPU Usage Distribution</h2>
                <div id="cpu-usage-chart" class="chart"></div>
                <button class="refresh-btn" onclick="refreshChart('cpu-usage')">Refresh</button>
            </div>
        </div>

        <div class="charts-grid" id="snapshot-view" style="display: none;">
            <div class="chart-container">
                <h2>Memory Usage - Performance Snapshot</h2>
                <div id="memory-snapshot-chart" class="chart"></div>
                <button class="refresh-btn" onclick="refreshChart('memory-snapshot')">Refresh</button>
            </div>
        </div>

        <div class="controls">
            <button class="control-btn" onclick="refreshAllCharts()">Refresh All Charts</button>
            <button class="control-btn" onclick="toggleAutoRefresh()">Toggle Auto-Refresh</button>
            <span class="auto-refresh-status" id="auto-refresh-status">Auto-refresh: OFF</span>
        </div>
    </div>

    <script>
        // Define refresh functions immediately in HTML to ensure they're always available
        console.log('üîß Defining inline refresh functions...');
        
        function refreshChart(chartType) {
            console.log('üîÑ Inline refreshChart called with:', chartType);
            
            if (window.dashboard && typeof window.dashboard.refreshChart === 'function') {
                console.log('‚úÖ Dashboard available, calling method');
                window.dashboard.refreshChart(chartType);
            } else {
                console.warn('‚è≥ Dashboard not ready, retrying...');
                alert('Dashboard is still loading. Please wait a moment and try again.');
                
                // Retry after a delay
                setTimeout(() => {
                    if (window.dashboard && typeof window.dashboard.refreshChart === 'function') {
                        window.dashboard.refreshChart(chartType);
                    } else {
                        alert('Dashboard failed to load. Please refresh the page.');
                    }
                }, 1000);
            }
        }
        
        function refreshAllCharts() {
            console.log('üîÑ Inline refreshAllCharts called');
            
            if (window.dashboard && typeof window.dashboard.refreshAllCharts === 'function') {
                console.log('‚úÖ Dashboard available, calling method');
                window.dashboard.refreshAllCharts();
            } else {
                console.warn('‚è≥ Dashboard not ready, retrying...');
                alert('Dashboard is still loading. Please wait a moment and try again.');
                
                // Retry after a delay
                setTimeout(() => {
                    if (window.dashboard && typeof window.dashboard.refreshAllCharts === 'function') {
                        window.dashboard.refreshAllCharts();
                    } else {
                        alert('Dashboard failed to load. Please refresh the page.');
                    }
                }, 1000);
            }
        }
        
        function toggleAutoRefresh() {
            console.log('üîÑ Inline toggleAutoRefresh called');
            
            if (window.dashboard && typeof window.dashboard.toggleAutoRefresh === 'function') {
                console.log('‚úÖ Dashboard available, calling method');
                window.dashboard.toggleAutoRefresh();
            } else {
                console.warn('‚è≥ Dashboard not ready, retrying...');
                alert('Dashboard is still loading. Please wait a moment and try again.');
                
                // Retry after a delay
                setTimeout(() => {
                    if (window.dashboard && typeof window.dashboard.toggleAutoRefresh === 'function') {
                        window.dashboard.toggleAutoRefresh();
                    } else {
                        alert('Dashboard failed to load. Please refresh the page.');
                    }
                }, 1000);
            }
        }
        
        console.log('‚úÖ Inline refresh functions defined');
    </script>

    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
</body>

</html>